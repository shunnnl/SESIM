pipeline {
  agent any

  environment {
    DEPLOY_KEY = '/var/jenkins_home/.ssh/sesim-saas-key-pair.pem'
    FE_SERVER_1 = '43.201.252.136'
    FE_SERVER_2 = '13.124.60.56'
    DEPLOY_PATH = '/home/ubuntu/sesim'
    FE_PROJECT_DIR = 'fe/sesim'
    FE_PROJECT_DIR_PATH = '/var/jenkins_home/workspace/sesim-frontend-deploy/fe/sesim'
  }

  options {
    skipDefaultCheckout true
  }

  stages {
    stage('Clone FE Branch') {
      steps {
        git branch: 'fe',
            url: 'https://lab.ssafy.com/s12-final/S12P31S109.git',
            credentialsId: 'sesim-gitlab'
      }
    }

    stage('Install & Build in fe/sesim') {
      steps {
        dir("${FE_PROJECT_DIR}") {
          sh '''
            rm -rf dist

            npm install

            npm run build
          '''
        }
      }
    }

    stage('Deploy to Frontend Servers') {
      steps {
        sh '''
          scp -i ${DEPLOY_KEY} -o StrictHostKeyChecking=no -r ${FE_PROJECT_DIR_PATH}/dist/* ubuntu@${FE_SERVER_1}:${DEPLOY_PATH}/dist

          scp -i ${DEPLOY_KEY} -o StrictHostKeyChecking=no -r ${FE_PROJECT_DIR_PATH}/dist/* ubuntu@${FE_SERVER_2}:${DEPLOY_PATH}/dist

          echo "âœ… í”„ë¡ íŠ¸ ë°°í¬ ì™„ë£Œ!"
        '''
      }
    }
  }

  post {
    success {
      script {
        def author = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()

        sh """
        curl -X POST -H 'Content-Type: application/json' \\
        -d '{
            "username": "ì„¸ì‹¬ Jenkins ë´‡",
            "icon_emoji": ":jenkins7:",
            "attachments": [{
                "fallback": "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ!",
                "color": "#00C851",
                "title": ":jenkins7: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µì´ ì„¸ì‹¬ì„ ê¸°ì˜ê²Œ í•©ë‹ˆë‹¤.",
                "text": "â€¢ **ğŸ§‘ğŸ»â€ğŸ’»ì‘ì„±ì**: ${author}\nâ€¢ **ğŸ“¦ ì„œë²„**: ${env.FE_SERVER_1}, ${env.FE_SERVER_2}\nâ€¢ **ğŸ› ï¸ ë¹Œë“œ ë²ˆí˜¸**: #${env.BUILD_NUMBER}\nâ€¢ ğŸ”— [Jenkins ë³´ëŸ¬ê°€ê¸°](${env.BUILD_URL})"
            }]
        }' https://meeting.ssafy.com/hooks/1wgxo7nc9td3zeedzh49yc61or
        """
      }
    }

    failure {
      script {
        def author = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
        def reason = currentBuild.getLog(10).collect { it.replaceAll('"', '\\"') }.join("\\n")

        sh """
        curl -X POST -H 'Content-Type: application/json' \\
        -d '{
            "username": "ì„¸ì‹¬ Jenkins ë´‡",
            "icon_emoji": ":jenkins7:",
            "attachments": [
                {
                "fallback": ":jenkins7: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨!",
                "color": "#ff4444",
                "title": "ğŸ”¥ ê¸´ê¸‰ì†ë³´: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
                "text": "â€¢ **ğŸ§‘ğŸ»â€ğŸ’»ì‘ì„±ì**: ${author} \nâ€¢ **ğŸ’¥ ë¹Œë“œ ë²ˆí˜¸**: #${env.BUILD_NUMBER}\nâ€¢ **ğŸ§ª ë¡œê·¸ ìš”ì•½**: ${reason}\nâ€¢ ğŸ”§ [Jenkinsë¡œ ë””ë²„ê¹…](${env.BUILD_URL})\n\n> ëˆ„êµ°ê°€... Jenkinsë¥¼... ë§ë ¤ì¤˜... ğŸ˜±"
                }
            ]
        }' https://meeting.ssafy.com/hooks/1wgxo7nc9td3zeedzh49yc61or
        """
      }
    }
  }
}
